package com.xinxing.o.boss.business.provider.other.fb.api;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;
import com.xinxing.boss.business.api.domain.SendOrderInfo;
import com.xinxing.boss.business.api.domain.SendOrderResult;
import com.xinxing.boss.business.api.domain.SendOrderStatus;
import com.xinxing.o.boss.business.provider.api.supplier.api.SendApi;
import com.xinxing.o.boss.business.provider.other.fb.util.FBUtils;
import com.xinxing.o.boss.common.http.HttpUtils;
import com.xinxing.o.boss.common.resource.Constants;
import com.xinxing.o.boss.common.util.FlowQueryLogUtils;
import com.xinxing.o.boss.common.util.FlowSendLogUtils;

public class FBSendAndApiimpl implements SendApi {

	private static Logger log = Logger.getLogger("分包逻辑供应商");

	@Override
	public SendOrderResult send(SendOrderInfo sendOrderInfo) {
		SendOrderResult result = null;

		String order_orderId = sendOrderInfo.getOrderId();

		try {
			String sendReq = FBUtils.getSendReq(sendOrderInfo);
			String sendUrl = Constants.getString("fb_sendUrl");

			// 发送请求 返回值 {"status":1,"msg":"订购成功"}
			FlowSendLogUtils.sendReqLog(log, order_orderId, sendReq);
			String sendRes = HttpUtils.sendPost1(sendUrl, sendReq, "application/json", "UTF-8");
			FlowSendLogUtils.sendResLog(log, order_orderId, sendRes);

			if (StringUtils.isNotBlank(sendRes)) {
				HashMap<String, String> sendMap = JSON.parseObject(sendRes, new TypeReference<HashMap<String, String>>() {
				});
				String status = sendMap.get("status");
				String msg = sendMap.get("msg");
				// String orderId = sendMap.get("orderId");

				switch (status) {
					case "1" :
					case "3" :
						result = new SendOrderResult(SendOrderStatus.WAIT_CALLBACK.status, null, order_orderId);
						break;
					case "2" :
						result = new SendOrderResult(SendOrderStatus.FAILED.status, status + ":" + msg, order_orderId);
						break;
					case "11" :
						result = new SendOrderResult(SendOrderStatus.NEED_MANUAL.status, status + ":" + msg, order_orderId);
						break;
					default :
						result = new SendOrderResult(SendOrderStatus.FAILED.status, status + ":" + msg, order_orderId);
				}
			} else {
				result = new SendOrderResult(SendOrderStatus.NEED_MANUAL.status, "充值返回为空,请找技术人员", order_orderId);
			}
		} catch (Exception e) {
			result = new SendOrderResult(SendOrderStatus.NEED_MANUAL.status, "系统异常,请找技术人员", order_orderId);
			FlowSendLogUtils.sendExceptionLog(log, order_orderId, e);
		}
		return result;
	}

	@Override
	public Map<String, SendOrderResult> querys(List<SendOrderInfo> sendOrderInfo) {

		Map<String, SendOrderResult> map = new HashMap<>();
		SendOrderResult result = null;
		String supplierOrderId = null;
		for (SendOrderInfo sendOrder : sendOrderInfo) {
			String order_orderId = sendOrder.getOrderId();
			try {
				String queryUrl = Constants.getString("fb_queryUrl");
				String queryReq = FBUtils.getQueryReq(sendOrder);

				// 发送请求
				FlowQueryLogUtils.queryReqLog(log, order_orderId, queryReq);
				String queryRes = HttpUtils.sendPost1(queryUrl, queryReq, "application/json", "utf-8");
				FlowQueryLogUtils.queryResLog(log, order_orderId, queryRes);

				if (StringUtils.isNotBlank(queryRes)) {
					HashMap<String, String> sendMap = JSON.parseObject(queryRes, new TypeReference<HashMap<String, String>>() {
					});
					String status = sendMap.get("status");
					String msg = sendMap.get("msg");
					supplierOrderId = sendMap.get("orderId");
					if (status != null) {
						switch (status) {
							case "11" :
								result = new SendOrderResult(SendOrderStatus.SUCCESS.status, null, supplierOrderId);
								break;
							case "2" :
								result = new SendOrderResult(SendOrderStatus.FAILED.status, status + ":" + msg, supplierOrderId);
								break;
							default :
								result = new SendOrderResult(SendOrderStatus.WAIT_CALLBACK.status, status + ":" + msg, supplierOrderId);
								break;
						}
					}
				} else {
					result = new SendOrderResult(SendOrderStatus.WAIT_CALLBACK.status, "查询返回为空,请找技术人员", supplierOrderId);
				}
			} catch (Exception e) {
				e.printStackTrace();
				result = new SendOrderResult(SendOrderStatus.NEED_MANUAL.status, "系统异常,请找技术人员", supplierOrderId);
				FlowQueryLogUtils.queryExceptionLog(log, order_orderId, e);
			}
			map.put(order_orderId, result);
		}
		return map;
	}

	@Override
	public SendOrderResult query(SendOrderInfo sendOrderInfo) {
		List<SendOrderInfo> queryList = new ArrayList<>();
		queryList.add(sendOrderInfo);
		Map<String, SendOrderResult> mapRes = querys(queryList);
		if (mapRes != null) {
			return mapRes.get(sendOrderInfo.getOrderId());
		}
		return null;
	}

}
